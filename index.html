<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Talism-e-Cobra</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- STYLES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #222; 
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- CONTROL PANEL --- */
        .controls {
            background: white;
            padding: 8px;
            display: flex; flex-wrap: wrap; gap: 6px;
            justify-content: center; align-items: flex-start;
            border-bottom: 3px solid #ff0000;
            z-index: 100;
            max-height: 40vh;
            overflow-y: auto;
        }

        .panel-group {
            background: #f8f9fa; border: 1px solid #ddd;
            padding: 6px 10px; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: flex-start;
        }
        .row { display: flex; gap: 5px; align-items: center; margin-bottom: 4px; }

        .group-label { 
            font-size: 11px; font-weight: bold; color: #d60000; 
            text-transform: uppercase; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 2px;
        }
        .input-label { font-size: 11px; color: #333; font-weight: bold; margin-right: 2px; }

        input, select, textarea { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        input[type="number"] { width: 50px; }
        
        .name-input {
            width: 180px; 
            margin-bottom: 3px;
            text-align: right;
            direction: rtl;
            font-family: 'Amiri', serif;
        }

        input[type="file"] { 
            font-size: 10px; width: 140px; 
            color: #333;
        }

        button {
            padding: 6px 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; font-size: 12px;
        }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-purple { background: #6f42c1; }
        
        /* --- WORKSPACE --- */
        .workspace {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background: #333;
        }

        .scroll-container {
            width: 100%; height: 100%;
            overflow: auto;
            display: flex; justify-content: center; align-items: flex-start;
            padding: 50px;
            touch-action: pan-x pan-y;
        }

        #paper {
            background-color: white;
            width: 1000px; height: 1000px; 
            box-shadow: 0 0 60px rgba(0,0,0,0.6);
        }

        svg { width: 100%; height: 100%; display: block; }
        
        /* Default font for UI */
        text { font-family: 'Amiri', 'Arial', sans-serif; font-weight: 700; direction: rtl; }

    </style>
</head>
<body>

    <div class="controls">
        
        <div class="panel-group">
            <div class="group-label">Target Names</div>
            <div class="row">
                <span class="input-label">Count:</span>
                <input type="number" id="numNames" value="1" min="1" max="20" onchange="createNameInputs()">
                <button class="btn-blue" onclick="generate()" style="margin-left: 10px;">Update Spiral</button>
            </div>
            <div id="namesContainer" style="display: flex; flex-direction: column; max-height: 100px; overflow-y: auto; padding-right: 5px;">
                </div>
        </div>

        <div class="panel-group">
            <div class="group-label">Center Font Style</div>
            
            <div class="row">
                <span class="input-label" style="width: 80px;">Upload Font:</span>
                <input type="file" id="centerFontInput" accept=".ttf,.otf,.woff" onchange="handleCenterFont(this)">
            </div>

            <div style="font-size: 10px; color: #666; margin-top: 4px;">
                Spiral: Automatic (Repo)<br>
                Mode: Mufrad (Separated)
            </div>
        </div>

        <div class="panel-group" style="background:none; border:none;">
            <div class="group-label">Export</div>
            <div class="row" style="flex-direction: column; align-items: stretch;">
                <button class="btn-purple" onclick="downloadSVG()">Download Single SVG</button>
                <button class="btn-green" onclick="downloadA4Sheet()" style="margin-top:5px;">Download Maximized A4</button>
            </div>
        </div>
        
        <div id="status" style="width:100%; text-align:center; color:#28a745; font-size:11px; margin-top:4px; font-weight:bold;">Ready</div>
    </div>

    <div class="workspace">
        <div class="scroll-container">
            <div id="paper">
                <svg id="mainSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
    </div>

    <canvas id="measureCanvas" style="display:none;"></canvas>

    <script>
        // --- FIXED CONSTANTS ---
        const TEXT_PREFIX = "توكلوا یا ملوك واعوان و خدام هذا الطلسم بابطال واخراج وسحب جمیع انواع السحر وخدام السحر والمس والتسالیط من وعن";
        const TEXT_SUFFIX = "الان الان الان";
        const CENTER_NUMBER = "٦٤١٥٨٤٧٣٩٢٩"; 
        
        const FIXED_COLOR = "#ff0000"; // Red
        const FIXED_SIZE = 65;
        const FIXED_GAP = 100;
        const FIXED_DIRECTION = "center"; // Center Out
        
        // --- REPO FONT CONFIGURATION ---
        const REPO_SPIRAL_FONT_PATH = "fonts/alqalam-quran-majeed.ttf";

        // --- SQUARE SETTINGS ---
        const USE_SQUARE = true;
        const SQUARE_SIZE = 750;

        let fullText = "";
        
        // Font Variables
        let spiralFontData = null; 
        let centerFontData = null; 
        
        let currentFontWeight = "700"; 

        // Initialization
        window.onload = async () => {
            const stat = document.getElementById('status');
            createNameInputs(); 

            stat.innerText = "Loading Spiral Font...";
            
            try {
                // Load Repo Spiral Font automatically
                spiralFontData = await loadFontFromUrl(REPO_SPIRAL_FONT_PATH);

                injectFontFaces();
                
                if (spiralFontData) {
                    stat.innerText = "Ready (Spiral Font Loaded)";
                } else {
                    stat.innerText = "Ready (Spiral Font Failed - Fallback used)";
                }

                generate();

            } catch(e) {
                console.error("Init error:", e);
                stat.innerText = "Font Load Error";
                generate();
            }
        };

        async function loadFontFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}`);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Font fetch error:", error);
                return null;
            }
        }

        function toMufrad(str) {
            if(!str) return "";
            return str.replace(/\s+/g, '').split('').join(' ');
        }

        function createNameInputs() {
            const count = parseInt(document.getElementById('numNames').value) || 1;
            const container = document.getElementById('namesContainer');
            
            const currentValues = [];
            const existingInputs = container.getElementsByTagName('input');
            for(let i=0; i<existingInputs.length; i++) {
                currentValues.push(existingInputs[i].value);
            }

            container.innerHTML = ""; 

            for (let i = 0; i < count; i++) {
                const inp = document.createElement("input");
                inp.type = "text";
                inp.className = "name-input";
                inp.placeholder = "Name " + (i + 1);
                if (i < currentValues.length) inp.value = currentValues[i];
                inp.addEventListener('input', generate); 
                container.appendChild(inp);
            }
            generate();
        }

        function constructFullString() {
            const container = document.getElementById('namesContainer');
            const inputs = container.getElementsByTagName('input');
            let namesArray = [];
            
            for(let i=0; i<inputs.length; i++) {
                let val = inputs[i].value.trim();
                if(val) namesArray.push(val);
            }

            let namesString = namesArray.length > 0 ? namesArray.join(" و ") : ".......";
            const combined = `${TEXT_PREFIX} ${namesString} ${TEXT_SUFFIX}`;
            return toMufrad(combined);
        }

        function handleCenterFont(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                centerFontData = e.target.result;
                injectFontFaces();
                generate();
                document.getElementById('status').innerText = "Center Font Updated";
            };
            reader.readAsDataURL(file);
        }

        function injectFontFaces() {
            const old = document.getElementById('dynamicFontStyle');
            if(old) old.remove();
            
            const newStyle = document.createElement('style');
            newStyle.id = 'dynamicFontStyle';
            
            let css = "";
            if(spiralFontData) {
                css += `@font-face { font-family: 'SpiralFont'; src: url('${spiralFontData}'); font-weight: normal; font-style: normal; }`;
            }
            if(centerFontData) {
                css += `@font-face { font-family: 'CenterFont'; src: url('${centerFontData}'); font-weight: normal; font-style: normal; }`;
            }
            
            newStyle.textContent = css;
            document.head.appendChild(newStyle);
            
            if(spiralFontData || centerFontData) {
                currentFontWeight = "normal";
            }
        }

        function generate() {
            fullText = constructFullString();
            if(!fullText) return;

            const svg = document.getElementById('mainSvg');
            svg.innerHTML = "";

            const ctx = document.getElementById('measureCanvas').getContext('2d');
            let measureFont = spiralFontData ? "SpiralFont" : "'Amiri', sans-serif";
            ctx.font = `${currentFontWeight} ${FIXED_SIZE}px ${measureFont}`;
            const textLen = ctx.measureText(fullText).width;

            const b = FIXED_GAP / (2 * Math.PI);
            let startRadius = USE_SQUARE ? (SQUARE_SIZE / 2 + 10) : 0; 
            let startTheta = startRadius / b;
            const endTheta = Math.sqrt( (2 * (textLen + 3000) / b) + (startTheta*startTheta) );

            const steps = 600 * ((endTheta - startTheta)/6);
            const stepSize = (endTheta - startTheta) / steps;
            
            let points = [];
            for(let t = startTheta; t <= endTheta; t+=stepSize) {
                points.push({ x: (b*t)*Math.cos(t), y: (b*t)*Math.sin(t) });
            }
            if(FIXED_DIRECTION === "center") points.reverse();

            if(points.length < 2) return;
            let d = `M ${points[0].x} ${points[0].y}`;
            for(let i=1; i<points.length; i++) d += ` L ${points[i].x} ${points[i].y}`;

            const style = document.createElementNS("http://www.w3.org/2000/svg", "style");
            
            let spiralFamily = spiralFontData ? "'SpiralFont'" : "'Amiri', 'Arial', sans-serif";
            let centerFamily = centerFontData ? "'CenterFont'" : "'Amiri', 'Arial', sans-serif";

            let svgCss = "";
            if(spiralFontData) svgCss += `@font-face { font-family: 'SpiralFont'; src: url('${spiralFontData}'); font-weight: normal; } `;
            if(centerFontData) svgCss += `@font-face { font-family: 'CenterFont'; src: url('${centerFontData}'); font-weight: normal; } `;

            svgCss += `
                .spiral-text { font-family: ${spiralFamily}; font-weight: ${currentFontWeight}; direction: rtl; }
                .center-text { font-family: ${centerFamily}; font-weight: ${currentFontWeight}; direction: rtl; }
            `;
            
            style.textContent = svgCss;
            svg.appendChild(style);

            const bgRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            bgRect.setAttribute("fill", "#ffffff"); 
            svg.appendChild(bgRect);

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("id", "spiralP");
            path.setAttribute("d", d);
            path.setAttribute("fill", "none");
            svg.appendChild(path);

            const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
            txt.setAttribute("class", "spiral-text"); 
            txt.setAttribute("font-size", FIXED_SIZE);
            txt.setAttribute("fill", FIXED_COLOR); 
            txt.setAttribute("dy", FIXED_SIZE * 0.35);

            const tp = document.createElementNS("http://www.w3.org/2000/svg", "textPath");
            tp.setAttribute("href", "#spiralP");
            tp.textContent = fullText;
            tp.setAttribute("startOffset", "100%");
            if(FIXED_DIRECTION === "center") tp.setAttribute("side", "right");
            
            txt.appendChild(tp);
            svg.appendChild(txt);
            
            const centerTxt = document.createElementNS("http://www.w3.org/2000/svg", "text");
            centerTxt.textContent = CENTER_NUMBER;
            centerTxt.setAttribute("class", "center-text"); 
            centerTxt.setAttribute("x", 0);
            centerTxt.setAttribute("y", 0);
            centerTxt.setAttribute("fill", FIXED_COLOR);
            centerTxt.setAttribute("font-size", "150"); 
            centerTxt.setAttribute("text-anchor", "middle"); 
            centerTxt.setAttribute("dominant-baseline", "middle"); 
            svg.appendChild(centerTxt);

            const maxR = b * endTheta;
            const dim = (maxR * 2) + (FIXED_SIZE * 2); 
            const minCoord = -dim / 2;

            svg.setAttribute("viewBox", `${minCoord} ${minCoord} ${dim} ${dim}`);
            bgRect.setAttribute("x", minCoord);
            bgRect.setAttribute("y", minCoord);
            bgRect.setAttribute("width", dim);
            bgRect.setAttribute("height", dim);
        }

        function downloadSVG() {
            const svg = document.getElementById('mainSvg');
            const ser = new XMLSerializer();
            let source = ser.serializeToString(svg);
            if(!source.match(/^<svg[^>]+xmlns/)) source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            const blob = new Blob([source], {type:"image/svg+xml;charset=utf-8"});
            saveFile(URL.createObjectURL(blob), "talisman.svg");
        }

        function downloadA4Sheet() {
            const status = document.getElementById('status');
            status.innerText = "Generating Maximized A4...";

            const canvasW = 7016; 
            const canvasH = 9933; 
            
            const cols = 2;
            const rows = 3;
            const gap = 20; 

            const availableW = canvasW - ((cols - 1) * gap);
            const availableH = canvasH - ((rows - 1) * gap);

            const cellW = availableW / cols;
            const cellH = availableH / rows;

            const itemSize = Math.min(cellW, cellH);

            const totalGridW = (cols * itemSize) + ((cols - 1) * gap);
            const totalGridH = (rows * itemSize) + ((rows - 1) * gap);
            
            const startX = (canvasW - totalGridW) / 2;
            const startY = (canvasH - totalGridH) / 2;

            const svg = document.getElementById('mainSvg');
            const oldW = svg.getAttribute("width");
            const oldH = svg.getAttribute("height");
            svg.setAttribute("width", itemSize);
            svg.setAttribute("height", itemSize);
            svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");

            const ser = new XMLSerializer();
            const svgData = ser.serializeToString(svg);

            if(oldW) svg.setAttribute("width", oldW); else svg.removeAttribute("width");
            if(oldH) svg.setAttribute("height", oldH); else svg.removeAttribute("height");

            const blob = new Blob([svgData], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement("canvas");
                canvas.width = canvasW;
                canvas.height = canvasH;
                const ctx = canvas.getContext("2d");
                
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvasW, canvasH);

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const x = startX + c * (itemSize + gap);
                        const y = startY + r * (itemSize + gap);
                        ctx.drawImage(img, x, y, itemSize, itemSize);
                    }
                }
                
                saveFile(canvas.toDataURL("image/png"), "talisman_A4_Ultra.png");
                URL.revokeObjectURL(url);
                status.innerText = "Done";
            };
            setTimeout(() => { img.src = url; }, 100);
        }

        function saveFile(url, name) {
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
